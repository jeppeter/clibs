TOPDIR=..\..

DYNAMICDIR=$(TOPDIR)\dynamiclib
STATICDIR=$(TOPDIR)\staticlib

CURDIR=.

CC      = cl
LD      = link
AR      = lib
RM      = del
CP      = copy /Y
MKDIR   = md.exe
MAKE    = nmake.exe

TARGET=cryptutil
STATICLIB_FILE = $(TARGET).lib
SHAREDLIB_FILE = $(TARGET).dll

HEADERS = crypt_md5.h crypt_aes.h crypt_mulmpi.h crypt_mpi.h crypt_mpn.h crypt_rsa.h crypt_sha256.h base64_code.h
SOURCES = crypt_md5.c crypt_aes.c crypt_mpi.c crypt_mpn.c crypt_rsa.c crypt_sha256.c base64_code.c
OBJECTS = $(SOURCES:.c=.obj)

!IFDEF UNICODE_MODE
!IF $(UNICODE_MODE) != 0
UNICODE_CFLAGS=-DUNICODE -D_UNICODE
!ELSE
UNICODE_CFLAGS=
!ENDIF
!ELSE
UNICODE_CFLAGS=
!ENDIF


!IFDEF MAKEVERBOSE

!IF $(MAKEVERBOSE) != 0
NOLOGO_CFLAGS = 
QUIETCMD=
NOLOG_MAKEFLAGS=
!ELSE
NOLOGO_CFLAGS = /nologo
QUIETCMD=@
NOLOG_MAKEFLAGS= /nologo
!ENDIF

!ELSE
QUIETCMD=@
NOLOGO_CFLAGS = /nologo
NOLOG_MAKEFLAGS= /nologo
!ENDIF

!IFDEF STATICLIB
!IF $(STATICLIB) != 0
WINLIB_CFLAGS = -DWINLIB_STATIC_EXPORT /MT
!ELSE
WINLIB_CFLAGS = -DWINLIB_DLL_EXPORT /MT
!ENDIF
!ELSE
WINLIB_CFLAGS = -DWINLIB_DLL_EXPORT /MT
!ENDIF



INC_CFLAGS = /I"$(TOPDIR)/winlib" /I"$(TOPDIR)/common" /I"$(TOPDIR)/common/cryptutil" $(WINLIB_CFLAGS)
COM_CFLAGS = /Wall /wd"4711" /wd"4255" /wd"4710" /wd"4996"
REL_CFLAGS = /O2
DBG_CFLAGS = /ZI /Od

REL_LDFLAGS = /NOLOGO /DLL
DBG_LDFLAGS = /NOLOGO /DLL /DEBUG

CFLAGS  = $(UNICODE_CFLAGS) $(NOLOGO_CFLAGS) $(INC_CFLAGS) $(COM_CFLAGS) $(REL_CFLAGS)
LDFLAGS = $(REL_LDFLAGS)
ARFLAGS = /NOLOGO /WX

LIB_SOURCE = crypt_md5.c crypt_aes.c crypt_mpi.c crypt_mpn.c crypt_rsa.c crypt_sha256.c base64_code.c
LIB_OBJECTS = $(LIB_SOURCE:.c=.obj)
OBJECTS = $(LIB_OBJECTS)


!IFDEF STATICLIB
!IF $(STATICLIB) != 0
all: $(STATICDIR)\$(STATICLIB_FILE)

$(STATICLIB_FILE): $(OBJECTS)
    $(QUIETCMD)$(AR) $(ARFLAGS) -out:$@ $(OBJECTS)


!ELSE
all: $(DYNAMICDIR)\$(STATICLIB_FILE) $(DYNAMICDIR)\$(SHAREDLIB_FILE)


$(STATICLIB_FILE): $(OBJECTS)
    $(QUIETCMD)$(AR) $(ARFLAGS) /DEF -out:$@ $(OBJECTS)

$(SHAREDLIB_FILE): $(OBJECTS) $(STATICLIB_FILE)
    $(QUIETCMD)$(LD) $(LDFLAGS) /DLL -out:$@ $(OBJECTS)

!ENDIF
!ELSE
all: $(DYNAMICDIR)\$(STATICLIB_FILE) $(DYNAMICDIR)\$(SHAREDLIB_FILE)

$(STATICLIB_FILE): $(OBJECTS)
    $(QUIETCMD)$(AR) $(ARFLAGS) -out:$@ $(OBJECTS) 

$(SHAREDLIB_FILE): $(OBJECTS) $(STATICLIB_FILE)
    $(QUIETCMD)$(LD) $(LDFLAGS) -dll -out:$@ $(OBJECTS)


!ENDIF

$(DYNAMICDIR)\$(SHAREDLIB_FILE):$(SHAREDLIB_FILE) $(DYNAMICDIR)
	$(QUIETCMD)$(CP) $(SHAREDLIB_FILE) $(DYNAMICDIR)\$(SHAREDLIB_FILE)

$(DYNAMICDIR):
	$(QUIETCMD)$(MKDIR) $(DYNAMICDIR) || echo "$(DYNAMICDIR) already"

$(STATICDIR)\$(STATICLIB_FILE):$(STATICLIB_FILE) $(STATICDIR)
	$(QUIETCMD)$(CP) $(STATICLIB_FILE) $(STATICDIR)\$(STATICLIB_FILE)

$(STATICDIR):
	$(QUIETCMD)$(MKDIR) $(STATICDIR) || echo "$(STATICDIR) already"

$(DYNAMICDIR)\$(STATICLIB_FILE):$(STATICLIB_FILE) $(DYNAMICDIR)
	$(QUIETCMD)$(CP) $(STATICLIB_FILE) $(DYNAMICDIR)\$(STATICLIB_FILE)


.c.obj:
    $(QUIETCMD)$(CC) $(CFLAGS) -c -Fo$@ $<


clean:
    $(QUIETCMD)$(RM) *.pdb *.idb *.ilk *.exp *.lib *.dll 2>NUL || echo ""
    $(QUIETCMD)$(RM) $(OBJECTS) 2>NUL || echo ""
    $(QUIETCMD)$(RM) $(STATICLIB_FILE) $(SHAREDLIB_FILE) 2>NUL || echo ""
    $(QUIETCMD)$(RM) /S $(STATICDIR)\$(STATICLIB_FILE)   2>NUL || echo ""
    $(QUIETCMD)$(RM) /S $(DYNAMICDIR)\$(SHAREDLIB_FILE)  2>NUL || echo ""
    $(QUIETCMD)$(RM) /S $(DYNAMICDIR)\$(STATICLIB_FILE)  2>NUL || echo ""
